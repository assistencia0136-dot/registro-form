<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
async function sendEmailWithPDF() {
    const { jsPDF } = window.jspdf;

    // 1️⃣ Coleta dos dados do formulário
    const cliente = document.getElementById("cliente").value || "-";
    const emailCliente = document.getElementById("email_cliente").value;
    const equipamento = document.getElementById("equipamento").value || "-";
    const obsInspecao = document.getElementById("obs_inspecao").value || "-";
    const acessorios = document.getElementById("acessorios").value || "-";
    const defeitos = document.getElementById("defeitos").value || "-";
    const observacoes = document.getElementById("observacoes").value || "-";
    const danificado = document.querySelector('input[name="danificado"]:checked')?.value || "-";
    const faltapecas = document.querySelector('input[name="faltapecas"]:checked')?.value || "-";
    const status = document.querySelector('input[name="status"]:checked')?.value || "-";
    const tipo = document.querySelector('input[name="tipo"]:checked')?.value || "-";
    
    // 2️⃣ Cria o PDF
    const pdf = new jsPDF();
    pdf.setFontSize(12);
    pdf.text("SUPPORTCARE TECNOLOGIA HOSPITALAR", 10, 10);
    pdf.text("REGISTRO DE COLETA E ENTREGA DIGITAL", 10, 18);
    pdf.text("Data/Hora: " + new Date().toLocaleString("pt-BR"), 10, 26);

    pdf.text(`Cliente: ${cliente}`, 10, 36);
    pdf.text(`Equipamento: ${equipamento}`, 10, 44);
    pdf.text(`Danificado? ${danificado}`, 10, 52);
    pdf.text(`Falta peças? ${faltapecas}`, 10, 60);
    pdf.text(`Status: ${status}`, 10, 68);
    pdf.text(`Tipo: ${tipo}`, 10, 76);

    pdf.text("Observações da Inspeção:", 10, 84);
    pdf.text(obsInspecao, 10, 92);
    pdf.text("Acessórios:", 10, 100);
    pdf.text(acessorios, 10, 108);
    pdf.text("Defeitos relatados pelo cliente:", 10, 116);
    pdf.text(defeitos, 10, 124);
    pdf.text("Observações gerais:", 10, 132);
    pdf.text(observacoes, 10, 140);

    // 3️⃣ Adiciona assinaturas
    const padClientCanvas = document.getElementById("signature-client");
    const padStaffCanvas = document.getElementById("signature-staff");
    const clientDataUrl = padClientCanvas.toDataURL();
    const staffDataUrl = padStaffCanvas.toDataURL();

    pdf.addPage();
    pdf.text("Assinaturas", 10, 10);
    pdf.text("Cliente:", 10, 20);
    pdf.addImage(clientDataUrl, 'PNG', 10, 25, 180, 60);
    pdf.text("Funcionário Supportcare:", 10, 95);
    pdf.addImage(staffDataUrl, 'PNG', 10, 100, 180, 60);

    // 4️⃣ Converte PDF em blob
    const pdfBlob = pdf.output('blob');
    const file = new File([pdfBlob], `Registro_${cliente}.pdf`, { type: 'application/pdf' });

    // 5️⃣ Tenta usar navigator.share (melhor experiência no celular)
    if (navigator.canShare && navigator.canShare({ files: [file] })) {
        try {
            await navigator.share({
                title: `Registro de ${tipo} - ${cliente}`,
                text: `Segue o registro de ${tipo} para o cliente ${cliente}.`,
                files: [file]
            });
        } catch (err) {
            alert("Falha ao compartilhar: " + err);
        }
        return;
    }

    // 6️⃣ Caso não seja suportado, abre mailto com download manual
    const pdfURL = URL.createObjectURL(file);
    const subject = encodeURIComponent(`Registro ${tipo} - Cliente: ${cliente} - Equipamento: ${equipamento}`);
    const body = encodeURIComponent(`Olá,\n\nSegue o registro de ${tipo} do cliente ${cliente}.\n\n[O PDF gerado está disponível para download neste link:] ${pdfURL}\n\nAtenciosamente,\nSupportcare`);
    window.location.href = `mailto:${emailCliente}?subject=${subject}&body=${body}`;
}
</script>

<!-- Substitua o botão Enviar -->
<button type="button" onclick="sendEmailWithPDF()">Enviar por E-mail</button>
